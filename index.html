<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚µã‚¤ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>ã‚µã‚¤ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
        
        <!-- ã‚µã‚¤ãƒˆç™»éŒ²ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
            <h2>æ–°ã—ã„ã‚µã‚¤ãƒˆã‚’ç™»éŒ²</h2>
            <form id="addSiteForm">
                <input type="text" id="urlInput" placeholder="URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" required>
                <button type="submit">ã‚µã‚¤ãƒˆç™»éŒ²</button>
            </form>
            <div id="addResult" class="message"></div>
        </div>
        
        <!-- ã‚µã‚¤ãƒˆé¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
            <h2>ç™»éŒ²æ¸ˆã¿ã‚µã‚¤ãƒˆ</h2>
            <div id="sitesList" class="sites-list"></div>
        </div>
        
        <!-- ãƒšãƒ¼ã‚¸ä¸€è¦§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section" id="pagesSection" style="display: none;">
            <h2>ãƒšãƒ¼ã‚¸ä¸€è¦§</h2>
            <div class="page-controls">
                <button id="scrapeButton">å…¨ãƒšãƒ¼ã‚¸å–å¾—</button>
                <span id="selectedSite"></span>
            </div>
            <div id="progressSection" class="progress-section" style="display: none;">
                <div class="progress-info">
                    <span id="progressText">æº–å‚™ä¸­...</span>
                    <span id="progressCount">0/0</span>
                </div>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
            </div>
            <div class="page-management">
                <div class="filter-controls">
                    <input type="text" id="keywordFilter" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ãƒ•ã‚£ãƒ«ã‚¿">
                    <button id="filterButton">ãƒ•ã‚£ãƒ«ã‚¿</button>
                    <button id="clearFilterButton">ã‚¯ãƒªã‚¢</button>
                </div>
                <div class="selection-controls">
                    <label><input type="checkbox" id="selectAllCheckbox"> å…¨é¸æŠ</label>
                    <button id="deleteSelectedButton" class="delete-button" disabled>é¸æŠã—ãŸURLã‚’å‰Šé™¤</button>
                </div>
            </div>
            <div id="pagesList" class="pages-list"></div>
            <div id="scrapeResult" class="message"></div>
        </div>

        <!-- SEOåˆ†æçµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section" id="analysisSection" style="display: none;">
            <h2>SEOåˆ†æçµæœ</h2>
            <div id="analysisUrl" class="analysis-url"></div>
            <div id="analysisResult" class="analysis-result">
                <div class="analysis-loading" id="analysisLoading">åˆ†æä¸­...</div>
                <div class="seo-improvements" id="seoImprovements" style="display: none;">
                    <h3>SEOæ”¹å–„ææ¡ˆ</h3>
                    <div id="improvementsList"></div>
                </div>
                <div class="topic-cluster" id="topicCluster" style="display: none;">
                    <h3>ãƒˆãƒ”ãƒƒã‚¯ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ç†è«–ã«ã‚ˆã‚‹æ”¹å–„æ¡ˆ</h3>
                    <div id="clusterSuggestions"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentSiteId = null;
        let currentSiteDomain = null;
        let allPages = [];
        let filteredPages = [];
        let isScrapingInProgress = false;
        let analyzedPages = new Set(); // åˆ†ææ¸ˆã¿ãƒšãƒ¼ã‚¸ã®URLã‚’è¨˜éŒ²

        // ã‚µã‚¤ãƒˆç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ 
        document.getElementById('addSiteForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const url = document.getElementById('urlInput').value;
            addSite(url);
        });

        // ã‚µã‚¤ãƒˆç™»éŒ²
        function addSite(url) {
            const resultDiv = document.getElementById('addResult');
            
            fetch('add_site.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'url=' + encodeURIComponent(url)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.className = 'message success';
                    resultDiv.textContent = data.message;
                    document.getElementById('urlInput').value = '';
                    loadSites(); // ã‚µã‚¤ãƒˆä¸€è¦§ã‚’æ›´æ–°
                } else {
                    resultDiv.className = 'message error';
                    resultDiv.textContent = data.message;
                }
            })
            .catch(error => {
                resultDiv.className = 'message error';
                resultDiv.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error;
            });
        }

        // ã‚µã‚¤ãƒˆä¸€è¦§èª­ã¿è¾¼ã¿
        function loadSites() {
            fetch('get_sites.php')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displaySites(data.sites);
                } else {
                    console.error('ã‚µã‚¤ãƒˆä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', data.message);
                }
            })
            .catch(error => {
                console.error('ã‚¨ãƒ©ãƒ¼:', error);
            });
        }

        // ã‚µã‚¤ãƒˆä¸€è¦§è¡¨ç¤º
        function displaySites(sites) {
            const sitesList = document.getElementById('sitesList');
            sitesList.innerHTML = '';

            if (sites.length === 0) {
                sitesList.innerHTML = '<p>ç™»éŒ²ã•ã‚ŒãŸã‚µã‚¤ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }

            sites.forEach(site => {
                const siteDiv = document.createElement('div');
                siteDiv.className = 'site-item';
                siteDiv.innerHTML = `
                    <span class="domain">${site.domain}</span>
                    <span class="date">${new Date(site.created_at).toLocaleString('ja-JP')}</span>
                `;
                siteDiv.addEventListener('click', () => selectSite(site.id, site.domain));
                sitesList.appendChild(siteDiv);
            });
        }

        // ã‚µã‚¤ãƒˆé¸æŠ
        function selectSite(siteId, domain) {
            currentSiteId = siteId;
            currentSiteDomain = domain;
            
            // åˆ†ææ¸ˆã¿çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆã‚µã‚¤ãƒˆãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆï¼‰
            analyzedPages.clear();
            
            // é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.site-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // ãƒšãƒ¼ã‚¸ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            document.getElementById('pagesSection').style.display = 'block';
            document.getElementById('selectedSite').textContent = 'é¸æŠä¸­: ' + domain;
            
            // ãƒšãƒ¼ã‚¸ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
            loadPages(siteId);
        }

        // ãƒšãƒ¼ã‚¸ä¸€è¦§èª­ã¿è¾¼ã¿
        function loadPages(siteId) {
            fetch('get_pages.php?site_id=' + siteId)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayPages(data.pages);
                } else {
                    console.error('ãƒšãƒ¼ã‚¸ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', data.message);
                }
            })
            .catch(error => {
                console.error('ã‚¨ãƒ©ãƒ¼:', error);
            });
        }

        // ãƒšãƒ¼ã‚¸ä¸€è¦§è¡¨ç¤º
        function displayPages(pages) {
            const pagesList = document.getElementById('pagesList');
            pagesList.innerHTML = '';
            
            allPages = pages;
            filteredPages = pages;

            if (pages.length === 0) {
                pagesList.innerHTML = '<p>ãƒšãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã€Œå…¨ãƒšãƒ¼ã‚¸å–å¾—ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚</p>';
                return;
            }

            renderPagesList(pages);
        }
        
        // ãƒšãƒ¼ã‚¸ãƒªã‚¹ãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderPagesList(pages) {
            const pagesList = document.getElementById('pagesList');
            pagesList.innerHTML = '';
            
            if (pages.length === 0) {
                pagesList.innerHTML = '<p>è©²å½“ã™ã‚‹ãƒšãƒ¼ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }

            pages.forEach((page, index) => {
                const pageDiv = document.createElement('div');
                pageDiv.className = 'page-item';
                
                // åˆ†ææ¸ˆã¿ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¦ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ±ºå®š
                const isAnalyzed = analyzedPages.has(page.url);
                const buttonText = isAnalyzed ? 'å†åˆ†æ' : 'åˆ†æ';
                const buttonClass = isAnalyzed ? 'reanalyze-btn' : 'analyze-btn';
                
                pageDiv.innerHTML = `
                    <label class="page-checkbox">
                        <input type="checkbox" value="${page.url}" data-index="${index}">
                        <a href="${page.url}" target="_blank">${page.url}</a>
                    </label>
                    <div class="page-actions">
                        <button class="${buttonClass}" id="btn-${index}" onclick="analyzePage('${page.url}', ${index}, ${isAnalyzed})">${buttonText}</button>
                    </div>
                `;
                pagesList.appendChild(pageDiv);
            });
            
            updateSelectAllCheckbox();
        }

        // ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œï¼ˆé€²æ—è¡¨ç¤ºä»˜ãï¼‰
        document.getElementById('scrapeButton').addEventListener('click', function() {
            if (!currentSiteId) {
                alert('ã‚µã‚¤ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            if (isScrapingInProgress) {
                alert('ç¾åœ¨å–å¾—ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
                return;
            }

            const button = this;
            const resultDiv = document.getElementById('scrapeResult');
            const progressSection = document.getElementById('progressSection');
            const progressText = document.getElementById('progressText');
            const progressCount = document.getElementById('progressCount');
            const progressFill = document.getElementById('progressFill');
            
            isScrapingInProgress = true;
            button.disabled = true;
            button.textContent = 'å–å¾—ä¸­...';
            resultDiv.textContent = '';
            progressSection.style.display = 'block';
            progressText.textContent = 'URLå–å¾—ã‚’é–‹å§‹ä¸­...';
            progressCount.textContent = '0/0';
            progressFill.style.width = '0%';

            fetch('scrape_progress.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'site_id=' + currentSiteId
            })
            .then(response => {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                
                function readStream() {
                    return reader.read().then(({ done, value }) => {
                        if (done) {
                            return;
                        }
                        
                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop();
                        
                        lines.forEach(line => {
                            if (line.trim()) {
                                try {
                                    const data = JSON.parse(line);
                                    handleProgressUpdate(data);
                                } catch (e) {
                                    console.error('JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', e, line);
                                }
                            }
                        });
                        
                        return readStream();
                    });
                }
                
                return readStream();
            })
            .catch(error => {
                resultDiv.className = 'message error';
                resultDiv.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error;
            })
            .finally(() => {
                isScrapingInProgress = false;
                button.disabled = false;
                button.textContent = 'å…¨ãƒšãƒ¼ã‚¸å–å¾—';
                progressSection.style.display = 'none';
            });
        });
        
        // é€²æ—æ›´æ–°å‡¦ç†
        function handleProgressUpdate(data) {
            const progressText = document.getElementById('progressText');
            const progressCount = document.getElementById('progressCount');
            const progressFill = document.getElementById('progressFill');
            const resultDiv = document.getElementById('scrapeResult');
            
            switch(data.type) {
                case 'start':
                    progressText.textContent = 'URLå–å¾—ä¸­...';
                    break;
                case 'progress':
                    const percentage = Math.round((data.processed / data.total) * 100);
                    progressText.textContent = `URLå–å¾—ä¸­... (${data.currentUrl})`;
                    progressCount.textContent = `${data.processed}/${data.total}`;
                    progressFill.style.width = `${percentage}%`;
                    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒšãƒ¼ã‚¸ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                    loadPages(currentSiteId);
                    break;
                case 'complete':
                    progressText.textContent = 'å®Œäº†';
                    progressFill.style.width = '100%';
                    resultDiv.className = 'message success';
                    resultDiv.textContent = data.message;
                    loadPages(currentSiteId);
                    break;
                case 'error':
                    resultDiv.className = 'message error';
                    resultDiv.textContent = data.message;
                    break;
            }
        }
        
        // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ•ã‚£ãƒ«ã‚¿
        document.getElementById('filterButton').addEventListener('click', function() {
            const keyword = document.getElementById('keywordFilter').value.toLowerCase();
            if (keyword.trim() === '') {
                filteredPages = allPages;
            } else {
                filteredPages = allPages.filter(page => page.url.toLowerCase().includes(keyword));
            }
            renderPagesList(filteredPages);
        });
        
        // ãƒ•ã‚£ãƒ«ã‚¿ã‚¯ãƒªã‚¢
        document.getElementById('clearFilterButton').addEventListener('click', function() {
            document.getElementById('keywordFilter').value = '';
            filteredPages = allPages;
            renderPagesList(filteredPages);
        });
        
        // Enterã‚­ãƒ¼ã§ãƒ•ã‚£ãƒ«ã‚¿
        document.getElementById('keywordFilter').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('filterButton').click();
            }
        });
        
        // å…¨é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
        document.getElementById('selectAllCheckbox').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('#pagesList input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateDeleteButton();
        });
        
        // å€‹åˆ¥ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¤‰æ›´ã‚’ç›£è¦–
        document.addEventListener('change', function(e) {
            if (e.target.matches('#pagesList input[type="checkbox"]')) {
                updateSelectAllCheckbox();
                updateDeleteButton();
            }
        });
        
        // å…¨é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹æ›´æ–°
        function updateSelectAllCheckbox() {
            const allCheckboxes = document.querySelectorAll('#pagesList input[type="checkbox"]');
            const checkedCheckboxes = document.querySelectorAll('#pagesList input[type="checkbox"]:checked');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            
            if (allCheckboxes.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCheckboxes.length === allCheckboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCheckboxes.length > 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            }
        }
        
        // å‰Šé™¤ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
        function updateDeleteButton() {
            const checkedCheckboxes = document.querySelectorAll('#pagesList input[type="checkbox"]:checked');
            const deleteButton = document.getElementById('deleteSelectedButton');
            deleteButton.disabled = checkedCheckboxes.length === 0;
        }
        
        // é¸æŠã—ãŸURLå‰Šé™¤
        document.getElementById('deleteSelectedButton').addEventListener('click', function() {
            const checkedCheckboxes = document.querySelectorAll('#pagesList input[type="checkbox"]:checked');
            if (checkedCheckboxes.length === 0) {
                alert('å‰Šé™¤ã™ã‚‹URLã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!confirm(`${checkedCheckboxes.length}å€‹ã®URLã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
            
            const urlsToDelete = Array.from(checkedCheckboxes).map(cb => cb.value);
            
            fetch('delete_pages.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    urls: urlsToDelete,
                    site_id: currentSiteId
                })
            })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('scrapeResult');
                if (data.success) {
                    resultDiv.className = 'message success';
                    resultDiv.textContent = data.message;
                    loadPages(currentSiteId);
                } else {
                    resultDiv.className = 'message error';
                    resultDiv.textContent = data.message;
                }
            })
            .catch(error => {
                const resultDiv = document.getElementById('scrapeResult');
                resultDiv.className = 'message error';
                resultDiv.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error;
            });
        });

        // ãƒšãƒ¼ã‚¸åˆ†ææ©Ÿèƒ½
        function analyzePage(url, index, isReanalysis = false) {
            const analysisSection = document.getElementById('analysisSection');
            const analysisUrl = document.getElementById('analysisUrl');
            const analysisLoading = document.getElementById('analysisLoading');
            const seoImprovements = document.getElementById('seoImprovements');
            const topicCluster = document.getElementById('topicCluster');
            
            // åˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            analysisSection.style.display = 'block';
            analysisUrl.textContent = 'åˆ†æå¯¾è±¡: ' + url;
            analysisLoading.style.display = 'block';
            analysisLoading.textContent = isReanalysis ? 'å†åˆ†æä¸­...' : 'åˆ†æä¸­...';
            seoImprovements.style.display = 'none';
            topicCluster.style.display = 'none';
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦åˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            analysisSection.scrollIntoView({ behavior: 'smooth' });
            
            // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’ä½œæˆ
            const formData = new FormData();
            formData.append('url', url);
            if (isReanalysis) {
                formData.append('force_reanalyze', '1');
            }
            
            // SEOåˆ†æã‚’å®Ÿè¡Œ
            fetch('seo_analysis.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                analysisLoading.style.display = 'none';
                
                if (data.success) {
                    // åˆ†ææ¸ˆã¿ã¨ã—ã¦è¨˜éŒ²
                    analyzedPages.add(url);
                    
                    // ãƒœã‚¿ãƒ³ã‚’ã€Œå†åˆ†æã€ã«å¤‰æ›´ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ã®èª­ã¿è¾¼ã¿æ™‚ã‚‚å«ã‚€ï¼‰
                    updateAnalyzeButton(index, url);
                    
                    displaySEOImprovements(data.improvements, data.debug, data.geminiRaw);
                    displayTopicClusterSuggestions(data.clusterSuggestions);
                } else {
                    const improvementsList = document.getElementById('improvementsList');
                    improvementsList.innerHTML = '<div class="error">åˆ†æã‚¨ãƒ©ãƒ¼: ' + data.message + '</div>';
                    seoImprovements.style.display = 'block';
                }
            })
            .catch(error => {
                analysisLoading.style.display = 'none';
                const improvementsList = document.getElementById('improvementsList');
                improvementsList.innerHTML = '<div class="error">åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error + '</div>';
                seoImprovements.style.display = 'block';
            });
        }
        
        // åˆ†æãƒœã‚¿ãƒ³ã‚’ã€Œå†åˆ†æã€ã«æ›´æ–°
        function updateAnalyzeButton(index, url) {
            const button = document.getElementById(`btn-${index}`);
            if (button) {
                button.textContent = 'å†åˆ†æ';
                button.className = 'reanalyze-btn';
                button.setAttribute('onclick', `analyzePage('${url}', ${index}, true)`);
            }
        }
        
        // SEOæ”¹å–„ææ¡ˆã®è¡¨ç¤º
        function displaySEOImprovements(improvements, debug, geminiRaw) {
            const improvementsList = document.getElementById('improvementsList');
            const seoImprovements = document.getElementById('seoImprovements');
            
            let html = '';
            
            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤ºï¼ˆé–‹ç™ºè€…å‘ã‘ï¼‰
            if (debug) {
                html += `
                    <div class="debug-info" style="background: #f0f0f0; padding: 10px; margin-bottom: 15px; border-radius: 5px; font-size: 12px;">
                        <strong>ğŸ” åˆ†æçŠ¶æ³:</strong><br>
                        Gemini APIå‘¼ã³å‡ºã—: ${debug.geminiCalled ? 'âœ…' : 'âŒ'}<br>
                        æ”¹å–„ææ¡ˆå–å¾—: ${debug.geminiHasImprovements ? 'âœ…' : 'âŒ'}<br>
                        ææ¡ˆæ•°: ${debug.improvementsCount}å€‹<br>
                        ${debug.geminiError ? 'ã‚¨ãƒ©ãƒ¼: ' + debug.geminiError + '<br>' : ''}
                        ${geminiRaw ? '<details><summary>AIå¿œç­”ã®ä¸€éƒ¨ (ã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹)</summary><pre style="white-space: pre-wrap; font-size: 11px;">' + geminiRaw + '</pre></details>' : ''}
                    </div>
                `;
            }
            
            if (improvements && improvements.length > 0) {
                improvements.forEach((improvement, index) => {
                    const typeLabel = improvement.type === 'ai-generated' ? 'ğŸ¤– AIåˆ†æ' : 
                                     improvement.type === 'debug' ? 'ğŸ”§ ãƒ‡ãƒãƒƒã‚°' : 
                                     improvement.type === 'fallback' ? 'âš ï¸ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯' : 'ğŸ“‹ åŸºæœ¬åˆ†æ';
                    
                    html += `
                        <div class="improvement-item" id="improvement-${index}">
                            <div class="improvement-header" onclick="toggleImprovementContent(${index})">
                                <h4>${typeLabel}: ${improvement.title}</h4>
                                <span class="toggle-icon">â–¼</span>
                            </div>
                            <div class="improvement-content" id="improvement-content-${index}">
                                <p>${improvement.description}</p>
                                <div class="improvement-actions">
                                    <button class="execute-btn" onclick="executeSpecificImprovement(${index}, '${improvement.type}', '${improvement.title}')">å®Ÿè¡Œ</button>
                                    <div class="execution-result-container" style="display: none;"></div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += `
                    <div class="error">
                        æ”¹å–„ææ¡ˆã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
                    </div>
                `;
            }
            
            improvementsList.innerHTML = html;
            seoImprovements.style.display = 'block';
        }
        
        // ãƒˆãƒ”ãƒƒã‚¯ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ææ¡ˆã®è¡¨ç¤º
        function displayTopicClusterSuggestions(suggestions) {
            const clusterSuggestions = document.getElementById('clusterSuggestions');
            const topicCluster = document.getElementById('topicCluster');
            
            let html = `
                <div class="cluster-item">
                    <h4>ãƒˆãƒ”ãƒƒã‚¯ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼æ§‹æˆææ¡ˆ</h4>
                    <p>${suggestions.description}</p>
                    <button class="execute-btn" onclick="executeClusterImprovement()">å®Ÿè¡Œ</button>
                </div>
            `;
            
            clusterSuggestions.innerHTML = html;
            topicCluster.style.display = 'block';
        }
        
        // å€‹åˆ¥ã®æ”¹å–„ææ¡ˆå®Ÿè¡Œ
        function executeSpecificImprovement(index, type, title) {
            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'å®Ÿè¡Œä¸­...';
            
            const analysisUrl = document.getElementById('analysisUrl').textContent.replace('åˆ†æå¯¾è±¡: ', '');
            
            // çµæœè¡¨ç¤ºç”¨ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’è¡¨ç¤º
            const resultContainer = button.parentElement.querySelector('.execution-result-container');
            resultContainer.style.display = 'block';
            resultContainer.innerHTML = '<div class="loading">åˆ†æã‚’å®Ÿè¡Œä¸­...</div>';
            
            fetch('execute_improvement.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    url: analysisUrl,
                    index: index,
                    type: type,
                    title: title
                })
            })
            .then(response => response.json())
            .then(data => {
                button.disabled = false;
                button.textContent = originalText;
                
                if (data.success) {
                    displaySpecificExecutionResult(data.result, resultContainer);
                } else {
                    resultContainer.innerHTML = '<div class="error">å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ' + data.message + '</div>';
                }
            })
            .catch(error => {
                button.disabled = false;
                button.textContent = originalText;
                resultContainer.innerHTML = '<div class="error">å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error + '</div>';
            });
        }
        
        // å¾“æ¥ã®å®Ÿè¡Œé–¢æ•°ï¼ˆäº’æ›æ€§ç¶­æŒã®ãŸã‚ï¼‰
        function executeImprovement(index, type) {
            return executeSpecificImprovement(index, type, 'æ”¹å–„ææ¡ˆ');
        }
        
        // ãƒˆãƒ”ãƒƒã‚¯ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼æ”¹å–„ã®å®Ÿè¡Œ
        function executeClusterImprovement() {
            const button = event.target;
            button.disabled = true;
            button.textContent = 'å®Ÿè¡Œä¸­...';
            
            const analysisUrl = document.getElementById('analysisUrl').textContent.replace('åˆ†æå¯¾è±¡: ', '');
            
            fetch('execute_cluster.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'url=' + encodeURIComponent(analysisUrl)
            })
            .then(response => response.json())
            .then(data => {
                button.disabled = false;
                button.textContent = 'å®Ÿè¡Œ';
                
                if (data.success) {
                    displayClusterResult(data.result);
                } else {
                    alert('å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ' + data.message);
                }
            })
            .catch(error => {
                button.disabled = false;
                button.textContent = 'å®Ÿè¡Œ';
                alert('å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error);
            });
        }
        
        // å€‹åˆ¥ã®æ”¹å–„çµæœè¡¨ç¤º
        function displaySpecificExecutionResult(result, container) {
            // Markdownã‚’HTMLã«å¤‰æ›
            const htmlResult = marked.parse(result);
            
            container.innerHTML = `
                <div class="execution-result">
                    <div class="result-header" onclick="toggleResultContent(this)">
                        <h5>æ”¹å–„ã®ãƒã‚¤ãƒ³ãƒˆ:</h5>
                        <span class="toggle-icon">â–¼</span>
                    </div>
                    <div class="result-content markdown-content">${htmlResult}</div>
                    <button class="copy-result-btn" onclick="copyResultToClipboard(this)">çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
                </div>
            `;
        }
        
        // å¾“æ¥ã®å®Ÿè¡Œçµæœè¡¨ç¤ºï¼ˆäº’æ›æ€§ç¶­æŒã®ãŸã‚ï¼‰
        function displayExecutionResult(result, parentElement) {
            const resultDiv = document.createElement('div');
            resultDiv.className = 'execution-result';
            resultDiv.innerHTML = `
                <h5>æ”¹å–„çµæœ:</h5>
                <div class="result-content">${result}</div>
            `;
            parentElement.appendChild(resultDiv);
        }
        
        // çµæœã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        function copyResultToClipboard(button) {
            const resultContent = button.parentElement.querySelector('.result-content').textContent;
            navigator.clipboard.writeText(resultContent).then(() => {
                const originalText = button.textContent;
                button.textContent = 'ã‚³ãƒ”ãƒ¼æ¸ˆã¿';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            }).catch(err => {
                console.error('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ:', err);
            });
        }
        
        // ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼çµæœã®è¡¨ç¤º
        function displayClusterResult(result) {
            const clusterSuggestions = document.getElementById('clusterSuggestions');
            
            let html = '';
            
            // ãƒ”ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸æƒ…å ±
            if (result.pillarPage) {
                html += `
                    <div class="pillar-page-section">
                        <h4>ğŸ›ï¸ ãƒ”ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ï¼ˆä¸­å¿ƒã¨ãªã‚‹åŒ…æ‹¬çš„ãƒšãƒ¼ã‚¸ï¼‰</h4>
                        <div class="pillar-content">
                            <p><strong>ã‚¿ã‚¤ãƒˆãƒ«:</strong> ${result.pillarPage.title}</p>
                            <p><strong>ãƒ¡ã‚¿ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³:</strong> ${result.pillarPage.metaDescription}</p>
                            <p><strong>ãƒ¡ã‚¤ãƒ³ãƒˆãƒ”ãƒƒã‚¯:</strong> ${result.pillarPage.mainTopic}</p>
                            <p><strong>ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:</strong> ${result.pillarPage.targetKeywords ? result.pillarPage.targetKeywords.join(', ') : 'N/A'}</p>
                            <p><strong>å†…å®¹æ¦‚è¦:</strong> ${result.pillarPage.description}</p>
                            <button class="create-content-btn" onclick="createPillarContent('${encodeURIComponent(JSON.stringify(result.pillarPage))}')">ãƒ”ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ä½œæˆ</button>
                        </div>
                    </div>
                `;
            }
            
            // ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãƒšãƒ¼ã‚¸ç¾¤
            if (result.clusterPages && result.clusterPages.length > 0) {
                html += `
                    <div class="cluster-pages-section">
                        <h4>ğŸ“„ ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãƒšãƒ¼ã‚¸ç¾¤ï¼ˆå€‹åˆ¥è©³ç´°è¨˜äº‹ï¼‰</h4>
                        <div class="cluster-pages-list">
                `;
                
                result.clusterPages.forEach((page, index) => {
                    html += `
                        <div class="cluster-page-item">
                            <h5>è¨˜äº‹ ${index + 1}: ${page.title}</h5>
                            <p><strong>ç‰¹å®šãƒˆãƒ”ãƒƒã‚¯:</strong> ${page.specificTopic}</p>
                            <p><strong>æ¤œç´¢æ„å›³:</strong> ${page.searchIntent}</p>
                            <p><strong>ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:</strong> ${page.targetKeywords ? page.targetKeywords.join(', ') : 'N/A'}</p>
                            <p><strong>ãƒ”ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ã¨ã®é–¢ä¿‚:</strong> ${page.relationToPillar}</p>
                            <button class="create-content-btn" onclick="createClusterContent('${encodeURIComponent(JSON.stringify(page))}', ${index})">ã“ã®è¨˜äº‹ã‚’ä½œæˆ</button>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            // ãƒªãƒ³ã‚¯æˆ¦ç•¥
            if (result.linkingStrategy) {
                html += `
                    <div class="linking-strategy-section">
                        <h4>ğŸ”— å†…éƒ¨ãƒªãƒ³ã‚¯æˆ¦ç•¥</h4>
                        <div class="linking-content">
                            <p><strong>ãƒ”ãƒ©ãƒ¼ â†’ ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼:</strong> ${result.linkingStrategy.pillarToCluster}</p>
                            <p><strong>ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ â†’ ãƒ”ãƒ©ãƒ¼:</strong> ${result.linkingStrategy.clusterToPillar}</p>
                            <p><strong>ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼é–“:</strong> ${result.linkingStrategy.clusterToCluster}</p>
                        </div>
                    </div>
                `;
            }
            
            // æ¸¬å®šå¯èƒ½ãªç›®æ¨™
            if (result.measurableGoals) {
                html += `
                    <div class="goals-section">
                        <h4>ğŸ¯ æ¸¬å®šå¯èƒ½ãªç›®æ¨™</h4>
                        <div class="goals-content">
                            <p><strong>é‡è¦ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:</strong> ${result.measurableGoals.primaryKeywords ? result.measurableGoals.primaryKeywords.join(', ') : 'N/A'}</p>
                            <p><strong>æœŸå¾…æµå…¥:</strong> ${result.measurableGoals.expectedTraffic}</p>
                            <p><strong>ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç›®æ¨™:</strong> ${result.measurableGoals.conversionGoals}</p>
                        </div>
                    </div>
                `;
            }
            
            const resultDiv = document.createElement('div');
            resultDiv.className = 'cluster-result';
            resultDiv.innerHTML = html;
            clusterSuggestions.appendChild(resultDiv);
        }
        
        // ãƒ”ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ä½œæˆ
        function createPillarContent(encodedResult) {
            const button = event.target;
            button.disabled = true;
            button.textContent = 'ä½œæˆä¸­...';
            
            const result = JSON.parse(decodeURIComponent(encodedResult));
            result.contentType = 'pillar';
            
            createContentRequest(result, button, 'ãƒ”ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ä½œæˆ');
        }
        
        // ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãƒšãƒ¼ã‚¸ä½œæˆ
        function createClusterContent(encodedResult, index) {
            const button = event.target;
            button.disabled = true;
            button.textContent = 'ä½œæˆä¸­...';
            
            const result = JSON.parse(decodeURIComponent(encodedResult));
            result.contentType = 'cluster';
            result.index = index;
            
            createContentRequest(result, button, 'ã“ã®è¨˜äº‹ã‚’ä½œæˆ');
        }
        
        // å¾“æ¥ã®æœ¬æ–‡ä½œæˆï¼ˆäº’æ›æ€§ç¶­æŒï¼‰
        function createContent(encodedResult) {
            const button = event.target;
            button.disabled = true;
            button.textContent = 'ä½œæˆä¸­...';
            
            const result = JSON.parse(decodeURIComponent(encodedResult));
            result.contentType = 'traditional';
            
            createContentRequest(result, button, 'æœ¬æ–‡ä½œæˆ');
        }
        
        // çµ±ä¸€ã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ä½œæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        function createContentRequest(result, button, originalText) {
            fetch('create_content.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(result)
            })
            .then(response => response.json())
            .then(data => {
                button.disabled = false;
                button.textContent = originalText;
                
                if (data.success) {
                    displayContentResult(data.content, button.parentElement);
                } else {
                    alert('ä½œæˆã‚¨ãƒ©ãƒ¼: ' + data.message);
                }
            })
            .catch(error => {
                button.disabled = false;
                button.textContent = originalText;
                alert('ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error);
            });
        }
        
        // æœ¬æ–‡ä½œæˆçµæœã®è¡¨ç¤º
        function displayContentResult(content, parentElement) {
            const contentDiv = document.createElement('div');
            contentDiv.className = 'content-result';
            contentDiv.innerHTML = `
                <h5>ä½œæˆã•ã‚ŒãŸæœ¬æ–‡ï¼ˆãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ï¼‰:</h5>
                <textarea class="content-textarea" readonly>${content}</textarea>
                <button class="copy-btn" onclick="copyToClipboard(this.previousElementSibling)">ã‚³ãƒ”ãƒ¼</button>
            `;
            parentElement.appendChild(contentDiv);
        }
        
        // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        function copyToClipboard(textarea) {
            textarea.select();
            document.execCommand('copy');
            
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'ã‚³ãƒ”ãƒ¼æ¸ˆã¿';
            setTimeout(() => {
                button.textContent = originalText;
            }, 2000);
        }

        // ãƒˆã‚°ãƒ«æ©Ÿèƒ½
        function toggleImprovementContent(index) {
            const content = document.getElementById(`improvement-content-${index}`);
            const icon = content.parentElement.querySelector('.toggle-icon');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                icon.classList.remove('collapsed');
            } else {
                content.classList.add('collapsed');
                icon.classList.add('collapsed');
            }
        }
        
        function toggleResultContent(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('.toggle-icon');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                icon.classList.remove('collapsed');
            } else {
                content.classList.add('collapsed');
                icon.classList.add('collapsed');
            }
        }

        // åˆ†ææ¸ˆã¿ãƒšãƒ¼ã‚¸çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦å¾©å…ƒ
        function checkExistingAnalyses() {
            // ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãƒšãƒ¼ã‚¸ã«ã¤ã„ã¦åˆ†ææ¸ˆã¿çŠ¶æ…‹ã‚’ç¢ºèª
            filteredPages.forEach((page, index) => {
                // å®Ÿéš›ã«ã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŒã€
                // ç°¡å˜ã®ãŸã‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§ç®¡ç†
                // å°†æ¥çš„ã«ã¯ get_analyzed_pages.php ãªã©ã§ç¢ºèª
            });
        }

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚µã‚¤ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        document.addEventListener('DOMContentLoaded', function() {
            loadSites();
        });
    </script>
</body>
</html>