<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>サイト管理システム</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="multi_ai_styles.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="topic_based_analysis_display.js"></script>
</head>
<body>
    <div class="container">
        <h1>サイト管理システム</h1>
        
        <!-- サイト登録セクション -->
        <div class="section">
            <h2>新しいサイトを登録</h2>
            <form id="addSiteForm">
                <input type="text" id="urlInput" placeholder="URLを入力してください" required>
                <button type="submit">サイト登録</button>
            </form>
            <div id="addResult" class="message"></div>
        </div>
        
        <!-- サイト選択セクション -->
        <div class="section">
            <h2>登録済みサイト</h2>
            <div id="sitesList" class="sites-list"></div>
        </div>
        
        <!-- ページ一覧セクション -->
        <div class="section" id="pagesSection" style="display: none;">
            <h2>ページ一覧</h2>
            <div class="page-controls">
                <button id="scrapeButton">全ページ取得</button>
                <span id="selectedSite"></span>
            </div>
            <div id="progressSection" class="progress-section" style="display: none;">
                <div class="progress-info">
                    <span id="progressText">準備中...</span>
                    <span id="progressCount">0/0</span>
                </div>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
            </div>
            <div class="page-management">
                <div class="filter-controls">
                    <input type="text" id="keywordFilter" placeholder="キーワードでフィルタ">
                    <button id="filterButton">フィルタ</button>
                    <button id="clearFilterButton">クリア</button>
                </div>
                <div class="selection-controls">
                    <label><input type="checkbox" id="selectAllCheckbox"> 全選択</label>
                    <button id="deleteSelectedButton" class="delete-button" disabled>選択したURLを削除</button>
                </div>
            </div>
            <div id="pagesList" class="pages-list"></div>
            <div id="scrapeResult" class="message"></div>
        </div>

        <!-- SEO分析結果セクション -->
        <div class="section" id="analysisSection" style="display: none;">
            <h2>SEO分析結果</h2>
            <div id="analysisUrl" class="analysis-url"></div>
            <div id="analysisResult" class="analysis-result">
                <div class="analysis-loading" id="analysisLoading">分析中...</div>
                <div class="seo-improvements" id="seoImprovements" style="display: none;">
                    <h3>SEO改善提案</h3>
                    <div id="improvementsList"></div>
                </div>
                <div class="topic-cluster" id="topicCluster" style="display: none;">
                    <h3>トピッククラスター理論による改善案</h3>
                    <div id="clusterSuggestions"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentSiteId = null;
        let currentSiteDomain = null;
        let allPages = [];
        let filteredPages = [];
        let isScrapingInProgress = false;
        let analyzedPages = new Set(); // 分析済みページのURLを記録

        // サイト登録フォーム
        document.getElementById('addSiteForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const url = document.getElementById('urlInput').value;
            addSite(url);
        });

        // サイト登録
        function addSite(url) {
            const resultDiv = document.getElementById('addResult');
            
            fetch('add_site.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'url=' + encodeURIComponent(url)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.className = 'message success';
                    resultDiv.textContent = data.message;
                    document.getElementById('urlInput').value = '';
                    loadSites(); // サイト一覧を更新
                } else {
                    resultDiv.className = 'message error';
                    resultDiv.textContent = data.message;
                }
            })
            .catch(error => {
                resultDiv.className = 'message error';
                resultDiv.textContent = 'エラーが発生しました: ' + error;
            });
        }

        // サイト一覧読み込み
        function loadSites() {
            fetch('get_sites.php')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displaySites(data.sites);
                } else {
                    console.error('サイト一覧の取得に失敗しました:', data.message);
                }
            })
            .catch(error => {
                console.error('エラー:', error);
            });
        }

        // サイト一覧表示
        function displaySites(sites) {
            const sitesList = document.getElementById('sitesList');
            sitesList.innerHTML = '';

            if (sites.length === 0) {
                sitesList.innerHTML = '<p>登録されたサイトがありません。</p>';
                return;
            }

            sites.forEach(site => {
                const siteDiv = document.createElement('div');
                siteDiv.className = 'site-item';
                siteDiv.innerHTML = `
                    <span class="domain">${site.domain}</span>
                    <span class="date">${new Date(site.created_at).toLocaleString('ja-JP')}</span>
                `;
                siteDiv.addEventListener('click', () => selectSite(site.id, site.domain));
                sitesList.appendChild(siteDiv);
            });
        }

        // サイト選択
        function selectSite(siteId, domain) {
            currentSiteId = siteId;
            currentSiteDomain = domain;
            
            // 分析済み状態をリセット（サイトが変更された場合）
            analyzedPages.clear();
            
            // 選択状態を更新
            document.querySelectorAll('.site-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // ページセクションを表示
            document.getElementById('pagesSection').style.display = 'block';
            document.getElementById('selectedSite').textContent = '選択中: ' + domain;
            
            // ページ一覧を読み込み
            loadPages(siteId);
        }

        // ページ一覧読み込み
        function loadPages(siteId) {
            fetch('get_pages.php?site_id=' + siteId)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayPages(data.pages);
                } else {
                    console.error('ページ一覧の取得に失敗しました:', data.message);
                }
            })
            .catch(error => {
                console.error('エラー:', error);
            });
        }

        // ページ一覧表示
        function displayPages(pages) {
            const pagesList = document.getElementById('pagesList');
            pagesList.innerHTML = '';
            
            allPages = pages;
            filteredPages = pages;

            if (pages.length === 0) {
                pagesList.innerHTML = '<p>ページが見つかりません。「全ページ取得」ボタンをクリックしてください。</p>';
                return;
            }

            renderPagesList(pages);
        }
        
        // ページリストのレンダリング
        function renderPagesList(pages) {
            const pagesList = document.getElementById('pagesList');
            pagesList.innerHTML = '';
            
            if (pages.length === 0) {
                pagesList.innerHTML = '<p>該当するページが見つかりません。</p>';
                return;
            }

            // 各ページの分析結果存在確認を非同期で実行（エラー時はスキップ）
            const pagePromises = pages.map(async (page, index) => {
                let hasAnalysis = false;
                try {
                    hasAnalysis = await checkAnalysisExists(page.url);
                } catch (error) {
                    console.warn(`Analysis check failed for ${page.url}, defaulting to no analysis:`, error);
                    hasAnalysis = false;
                }
                return { page, index, hasAnalysis };
            });

            Promise.all(pagePromises).then(results => {
                results.forEach(({ page, index, hasAnalysis }) => {
                    const pageDiv = document.createElement('div');
                    pageDiv.className = 'page-item';
                    
                    let buttonsHtml = '';
                    if (hasAnalysis) {
                        buttonsHtml = `
                            <button class="show-results-btn" onclick="showAnalysisResults('${page.url}', ${index})">分析結果を表示</button>
                            <button class="reanalyze-btn" onclick="reanalyzePageMultiAI('${page.url}', ${index})">再分析</button>
                        `;
                    } else {
                        buttonsHtml = `<button class="analyze-btn" onclick="analyzePageMultiAI('${page.url}', ${index})">3AI分析実行</button>`;
                    }
                    
                    pageDiv.innerHTML = `
                        <label class="page-checkbox">
                            <input type="checkbox" value="${page.url}" data-index="${index}">
                            <a href="${page.url}" target="_blank">${page.url}</a>
                        </label>
                        <div class="page-actions">
                            ${buttonsHtml}
                        </div>
                    `;
                    pagesList.appendChild(pageDiv);
                });
                
                updateSelectAllCheckbox();
            });
        }

        // 分析結果が存在するかチェック
        async function checkAnalysisExists(url) {
            try {
                console.log(`Checking analysis for URL: ${url}`);
                const response = await fetch('check_analysis_results.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'url=' + encodeURIComponent(url)
                });
                
                if (!response.ok) {
                    console.error(`HTTP Error ${response.status}: ${response.statusText} for ${url}`);
                    const errorText = await response.text();
                    console.error('Error response body:', errorText);
                    return false;
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const responseText = await response.text();
                    console.error('Non-JSON response received:', responseText);
                    return false;
                }
                
                const data = await response.json();
                console.log('Response data:', data);
                
                // エラー情報があれば表示
                if (data.error) {
                    console.error('API Error:', data.error);
                }
                
                // デバッグ情報があれば表示
                if (data.debug) {
                    console.warn('Database debug info:', data.debug);
                }
                
                return data.success && data.hasAnalysis;
            } catch (error) {
                console.error('分析結果チェックエラー:', error.message);
                console.error('Error details:', error);
                return false;
            }
        }

        // スクレイピング実行（進捗表示付き）
        document.getElementById('scrapeButton').addEventListener('click', function() {
            if (!currentSiteId) {
                alert('サイトを選択してください');
                return;
            }
            
            if (isScrapingInProgress) {
                alert('現在取得中です。しばらくお待ちください。');
                return;
            }

            const button = this;
            const resultDiv = document.getElementById('scrapeResult');
            const progressSection = document.getElementById('progressSection');
            const progressText = document.getElementById('progressText');
            const progressCount = document.getElementById('progressCount');
            const progressFill = document.getElementById('progressFill');
            
            isScrapingInProgress = true;
            button.disabled = true;
            button.textContent = '取得中...';
            resultDiv.textContent = '';
            progressSection.style.display = 'block';
            progressText.textContent = 'URL取得を開始中...';
            progressCount.textContent = '0/0';
            progressFill.style.width = '0%';

            fetch('scrape_progress.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'site_id=' + currentSiteId
            })
            .then(response => {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                
                function readStream() {
                    return reader.read().then(({ done, value }) => {
                        if (done) {
                            return;
                        }
                        
                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop();
                        
                        lines.forEach(line => {
                            if (line.trim()) {
                                try {
                                    const data = JSON.parse(line);
                                    handleProgressUpdate(data);
                                } catch (e) {
                                    console.error('JSONパースエラー:', e, line);
                                }
                            }
                        });
                        
                        return readStream();
                    });
                }
                
                return readStream();
            })
            .catch(error => {
                resultDiv.className = 'message error';
                resultDiv.textContent = 'エラーが発生しました: ' + error;
            })
            .finally(() => {
                isScrapingInProgress = false;
                button.disabled = false;
                button.textContent = '全ページ取得';
                progressSection.style.display = 'none';
            });
        });
        
        // 進捗更新処理
        function handleProgressUpdate(data) {
            const progressText = document.getElementById('progressText');
            const progressCount = document.getElementById('progressCount');
            const progressFill = document.getElementById('progressFill');
            const resultDiv = document.getElementById('scrapeResult');
            
            switch(data.type) {
                case 'start':
                    progressText.textContent = 'URL取得中...';
                    break;
                case 'progress':
                    const percentage = Math.round((data.processed / data.total) * 100);
                    progressText.textContent = `URL取得中... (${data.currentUrl})`;
                    progressCount.textContent = `${data.processed}/${data.total}`;
                    progressFill.style.width = `${percentage}%`;
                    // リアルタイムでページリストを更新
                    loadPages(currentSiteId);
                    break;
                case 'complete':
                    progressText.textContent = '完了';
                    progressFill.style.width = '100%';
                    resultDiv.className = 'message success';
                    resultDiv.textContent = data.message;
                    loadPages(currentSiteId);
                    break;
                case 'error':
                    resultDiv.className = 'message error';
                    resultDiv.textContent = data.message;
                    break;
            }
        }
        
        // キーワードフィルタ
        document.getElementById('filterButton').addEventListener('click', function() {
            const keyword = document.getElementById('keywordFilter').value.toLowerCase();
            if (keyword.trim() === '') {
                filteredPages = allPages;
            } else {
                filteredPages = allPages.filter(page => page.url.toLowerCase().includes(keyword));
            }
            renderPagesList(filteredPages);
        });
        
        // フィルタクリア
        document.getElementById('clearFilterButton').addEventListener('click', function() {
            document.getElementById('keywordFilter').value = '';
            filteredPages = allPages;
            renderPagesList(filteredPages);
        });
        
        // Enterキーでフィルタ
        document.getElementById('keywordFilter').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('filterButton').click();
            }
        });
        
        // 全選択チェックボックス
        document.getElementById('selectAllCheckbox').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('#pagesList input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateDeleteButton();
        });
        
        // 個別チェックボックスの変更を監視
        document.addEventListener('change', function(e) {
            if (e.target.matches('#pagesList input[type="checkbox"]')) {
                updateSelectAllCheckbox();
                updateDeleteButton();
            }
        });
        
        // 全選択チェックボックスの状態更新
        function updateSelectAllCheckbox() {
            const allCheckboxes = document.querySelectorAll('#pagesList input[type="checkbox"]');
            const checkedCheckboxes = document.querySelectorAll('#pagesList input[type="checkbox"]:checked');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            
            if (allCheckboxes.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCheckboxes.length === allCheckboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCheckboxes.length > 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            }
        }
        
        // 削除ボタンの状態更新
        function updateDeleteButton() {
            const checkedCheckboxes = document.querySelectorAll('#pagesList input[type="checkbox"]:checked');
            const deleteButton = document.getElementById('deleteSelectedButton');
            deleteButton.disabled = checkedCheckboxes.length === 0;
        }
        
        // 選択したURL削除
        document.getElementById('deleteSelectedButton').addEventListener('click', function() {
            const checkedCheckboxes = document.querySelectorAll('#pagesList input[type="checkbox"]:checked');
            if (checkedCheckboxes.length === 0) {
                alert('削除するURLを選択してください');
                return;
            }
            
            if (!confirm(`${checkedCheckboxes.length}個のURLを削除しますか？`)) {
                return;
            }
            
            const urlsToDelete = Array.from(checkedCheckboxes).map(cb => cb.value);
            
            fetch('delete_pages.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    urls: urlsToDelete,
                    site_id: currentSiteId
                })
            })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('scrapeResult');
                if (data.success) {
                    resultDiv.className = 'message success';
                    resultDiv.textContent = data.message;
                    loadPages(currentSiteId);
                } else {
                    resultDiv.className = 'message error';
                    resultDiv.textContent = data.message;
                }
            })
            .catch(error => {
                const resultDiv = document.getElementById('scrapeResult');
                resultDiv.className = 'message error';
                resultDiv.textContent = 'エラーが発生しました: ' + error;
            });
        });

        // 新しい3AI分析機能
        function analyzePageMultiAI(url, index) {
            executeMultiAIAnalysis(url, index, false);
        }

        // 再分析機能
        function reanalyzePageMultiAI(url, index) {
            executeMultiAIAnalysis(url, index, true);
        }

        // 改善議題ベース3AI分析実行
        function executeMultiAIAnalysis(url, index, isReanalysis = false) {
            const analysisSection = document.getElementById('analysisSection');
            const analysisUrl = document.getElementById('analysisUrl');
            const analysisLoading = document.getElementById('analysisLoading');
            const seoImprovements = document.getElementById('seoImprovements');
            const topicCluster = document.getElementById('topicCluster');
            
            // 分析セクションを表示
            analysisSection.style.display = 'block';
            analysisUrl.textContent = '分析対象: ' + url;
            analysisLoading.style.display = 'none'; // 新しいシステムでは個別に表示
            seoImprovements.style.display = 'block';
            topicCluster.style.display = 'none';
            
            // スクロールして分析セクションを表示
            analysisSection.scrollIntoView({ behavior: 'smooth' });
            
            // 改善一覧のコンテナをクリア（新しいレイアウトで表示）
            const improvementsList = document.getElementById('improvementsList');
            improvementsList.innerHTML = '<div id="multiAIResults"></div>';
            
            // 新しいレイアウトシステムを使用して分析開始
            if (window.TopicBasedAnalysis && window.TopicBasedAnalysis.start) {
                window.TopicBasedAnalysis.start(url, isReanalysis)
                    .then(data => {
                        if (data.success) {
                            // ページリストを更新してボタン表示を変更
                            renderPagesList(filteredPages);
                        } else {
                            improvementsList.innerHTML = '<div class="error">3AI分析エラー: ' + data.message + '</div>';
                        }
                    })
                    .catch(error => {
                        console.error('分析エラー:', error);
                        improvementsList.innerHTML = '<div class="error">3AI分析中にエラーが発生しました: ' + error.message + '</div>';
                    });
            } else {
                // フォールバック: 従来のシステム
                console.warn('TopicBasedAnalysis システムが利用できません。従来のシステムにフォールバック。');
                const formData = new FormData();
                formData.append('url', url);
                if (isReanalysis) {
                    formData.append('force_reanalyze', '1');
                }
                
                fetch('multi_ai_analysis.php', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayMultiAIResults(data.multiAIResults, data.finalSuggestion, data.fromCache);
                        renderPagesList(filteredPages);
                    } else {
                        improvementsList.innerHTML = '<div class="error">3AI分析エラー: ' + data.message + '</div>';
                    }
                })
                .catch(error => {
                    improvementsList.innerHTML = '<div class="error">3AI分析中にエラーが発生しました: ' + error + '</div>';
                });
            }
        }

        // 既存の分析結果を表示
        function showAnalysisResults(url, index) {
            const analysisSection = document.getElementById('analysisSection');
            const analysisUrl = document.getElementById('analysisUrl');
            const analysisLoading = document.getElementById('analysisLoading');
            const seoImprovements = document.getElementById('seoImprovements');
            const topicCluster = document.getElementById('topicCluster');
            
            // 分析セクションを表示
            analysisSection.style.display = 'block';
            analysisUrl.textContent = '分析対象: ' + url;
            analysisLoading.style.display = 'block';
            analysisLoading.textContent = '既存分析結果を読み込み中...';
            seoImprovements.style.display = 'none';
            topicCluster.style.display = 'none';
            
            // スクロールして分析セクションを表示
            analysisSection.scrollIntoView({ behavior: 'smooth' });
            
            // 既存の分析結果を取得
            const formData = new FormData();
            formData.append('url', url);
            
            fetch('get_analysis_results.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                analysisLoading.style.display = 'none';
                
                if (data.success) {
                    displayMultiAIResults(data.multiAIResults, data.finalSuggestion, true);
                } else {
                    const improvementsList = document.getElementById('improvementsList');
                    improvementsList.innerHTML = '<div class="error">分析結果の取得に失敗しました: ' + data.message + '</div>';
                    seoImprovements.style.display = 'block';
                }
            })
            .catch(error => {
                analysisLoading.style.display = 'none';
                const improvementsList = document.getElementById('improvementsList');
                improvementsList.innerHTML = '<div class="error">分析結果の取得中にエラーが発生しました: ' + error + '</div>';
                seoImprovements.style.display = 'block';
            });
        }

        // 従来のページ分析機能（互換性維持）
        function analyzePage(url, index, isReanalysis = false) {
            // 新しい3AI分析にリダイレクト
            if (isReanalysis) {
                reanalyzePageMultiAI(url, index);
            } else {
                analyzePageMultiAI(url, index);
            }
        }
        
        // 分析ボタンを「再分析」に更新
        function updateAnalyzeButton(index, url) {
            const button = document.getElementById(`btn-${index}`);
            if (button) {
                button.textContent = '再分析';
                button.className = 'reanalyze-btn';
                button.setAttribute('onclick', `analyzePage('${url}', ${index}, true)`);
            }
        }
        
        // 3AI分析結果を表示
        function displayMultiAIResults(multiAIResults, finalSuggestion, fromCache = false) {
            const improvementsList = document.getElementById('improvementsList');
            const seoImprovements = document.getElementById('seoImprovements');
            
            let html = '';
            
            // キャッシュ情報
            if (fromCache) {
                html += `<div class="analysis-cache-info">💾 データベースから既存の分析結果を表示しています</div>`;
            }
            
            // 3AI分析結果セクション
            html += `<div class="multi-ai-analysis">`;
            html += `<h3>🤖 3AI分析結果</h3>`;
            html += `<div class="multi-ai-results">`;
            
            // Gemini結果
            if (multiAIResults.gemini) {
                html += createAIResultCard('gemini', 'Google Gemini', multiAIResults.gemini);
            }
            
            // OpenAI結果
            if (multiAIResults.openai) {
                html += createAIResultCard('openai', 'OpenAI GPT-4', multiAIResults.openai);
            }
            
            // Claude結果
            if (multiAIResults.claude) {
                html += createAIResultCard('claude', 'Anthropic Claude', multiAIResults.claude);
            }
            
            html += `</div>`; // multi-ai-results終了
            
            // 最終統合提案セクション
            if (finalSuggestion) {
                html += createFinalSuggestionSection(finalSuggestion);
            }
            
            html += `</div>`; // multi-ai-analysis終了
            
            improvementsList.innerHTML = html;
            seoImprovements.style.display = 'block';
        }

        // AI結果カード作成（新構造対応：改善議題→AIからの提案）
        function createAIResultCard(aiType, aiName, result) {
            if (result.error) {
                return `
                    <div class="ai-result-card ${aiType}">
                        <div class="ai-result-header">
                            <div class="ai-icon ${aiType}"></div>
                            ${aiName}
                        </div>
                        <div class="ai-error">${result.error}</div>
                    </div>
                `;
            }
            
            let html = `
                <div class="ai-result-card ${aiType}">
                    <div class="ai-result-header">
                        <div class="ai-icon ${aiType}"></div>
                        ${aiName}
                    </div>
            `;
            
            // 新構造：improvementTopics で改善議題→AIからの提案
            if (result.improvementTopics) {
                const topics = result.improvementTopics;
                const topicLabels = {
                    'title': 'タイトルの改善',
                    'metaDescription': 'メタディスクリプションの改善',
                    'headingStructure': '見出し構造の改善',
                    'contentImprovement': 'コンテンツ内容の改善',
                    'internalLinks': '内部リンク戦略の改善'
                };
                
                Object.entries(topics).forEach(([topicKey, topicData]) => {
                    const itemId = `${aiType}-topic-${topicKey}`;
                    const topicLabel = topicLabels[topicKey] || topicKey;
                    
                    html += `
                        <div class="ai-improvement-item">
                            <div class="ai-improvement-header" onclick="toggleAIImprovementContent('${itemId}')">
                                <div>
                                    <strong>${topicLabel}</strong>
                                    ${topicData.priority ? `<span class="priority-badge ${topicData.priority}">${topicData.priority}</span>` : ''}
                                </div>
                                <span class="toggle-icon">▼</span>
                            </div>
                            <div class="ai-improvement-content" id="${itemId}">
                                ${topicData.conclusion ? `
                                    <div class="ai-improvement-conclusion">
                                        <h6>💡 結論（コピペで使用可能）</h6>
                                        <div>${topicData.conclusion}</div>
                                    </div>
                                ` : ''}
                                ${topicData.explanation ? `
                                    <div class="ai-improvement-explanation">
                                        <strong>📝 説明・根拠</strong><br>
                                        ${topicData.explanation}
                                    </div>
                                ` : ''}
                                ${topicData.expectedResult ? `
                                    <div class="ai-improvement-explanation">
                                        <strong>🎯 期待される効果</strong><br>
                                        ${topicData.expectedResult}
                                    </div>
                                ` : ''}
                                ${topicData.aiName ? `
                                    <div class="ai-improvement-explanation">
                                        <strong>🤖 担当AI</strong><br>
                                        ${topicData.aiName}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
            } else if (result.improvements && Array.isArray(result.improvements)) {
                // 旧構造との互換性
                result.improvements.forEach((improvement, index) => {
                    const itemId = `${aiType}-improvement-${index}`;
                    html += `
                        <div class="ai-improvement-item">
                            <div class="ai-improvement-header" onclick="toggleAIImprovementContent('${itemId}')">
                                <div>
                                    <strong>${improvement.title || 'AI提案'}</strong>
                                    ${improvement.priority ? `<span class="priority-badge ${improvement.priority}">${improvement.priority}</span>` : ''}
                                </div>
                                <span class="toggle-icon">▼</span>
                            </div>
                            <div class="ai-improvement-content" id="${itemId}">
                                ${improvement.conclusion ? `
                                    <div class="ai-improvement-conclusion">
                                        <h6>💡 結論（コピペで使用可能）</h6>
                                        <div>${improvement.conclusion}</div>
                                    </div>
                                ` : ''}
                                ${improvement.explanation ? `
                                    <div class="ai-improvement-explanation">
                                        <strong>📝 説明・根拠</strong><br>
                                        ${improvement.explanation}
                                    </div>
                                ` : ''}
                                ${improvement.expectedResult ? `
                                    <div class="ai-improvement-explanation">
                                        <strong>🎯 期待される効果</strong><br>
                                        ${improvement.expectedResult}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
            } else if (result.rawText) {
                html += `<div class="ai-error">構造化されていないテキスト応答: ${result.rawText.substring(0, 200)}...</div>`;
            } else {
                html += `<div class="ai-error">分析結果が取得できませんでした</div>`;
            }
            
            html += `</div>`;
            return html;
        }

        // 最終統合提案セクション作成（新構造対応：改善議題→3AI統合最終提案）
        function createFinalSuggestionSection(finalSuggestion) {
            let html = `
                <div class="final-suggestion-section">
                    <div class="final-suggestion-header">
                        <h3>🏆 統合最終提案 (3AI分析結果を統合)</h3>
                    </div>
            `;
            
            // 新構造：finalTopicSuggestions で改善議題→統合最終提案
            if (finalSuggestion.gemini && finalSuggestion.gemini.finalTopicSuggestions) {
                html += createTopicBasedFinalSection('Gemini統合分析', finalSuggestion.gemini);
            } else if (finalSuggestion.openai && finalSuggestion.openai.finalTopicSuggestions) {
                html += createTopicBasedFinalSection('OpenAI統合分析', finalSuggestion.openai);
            } else if (finalSuggestion.claude && finalSuggestion.claude.finalTopicSuggestions) {
                html += createTopicBasedFinalSection('Claude統合分析', finalSuggestion.claude);
            } else {
                // 旧構造との互換性
                html += `<div class="final-analysis-grid">`;
                
                // Gemini最終提案
                if (finalSuggestion.gemini && finalSuggestion.gemini.finalImprovement) {
                    html += createFinalAnalysisCard('Gemini統合案', finalSuggestion.gemini.finalImprovement);
                }
                
                // OpenAI最終提案
                if (finalSuggestion.openai && finalSuggestion.openai.finalImprovement) {
                    html += createFinalAnalysisCard('OpenAI統合案', finalSuggestion.openai.finalImprovement);
                }
                
                // Claude最終提案
                if (finalSuggestion.claude && finalSuggestion.claude.finalImprovement) {
                    html += createFinalAnalysisCard('Claude統合案', finalSuggestion.claude.finalImprovement);
                }
                
                html += `</div>`;
            }
            
            html += `</div>`;
            
            return html;
        }
        
        // 改善議題別の統合最終提案セクション作成
        function createTopicBasedFinalSection(analysisTitle, finalData) {
            const topicLabels = {
                'title': 'タイトルの改善',
                'metaDescription': 'メタディスクリプションの改善',
                'headingStructure': '見出し構造の改善',
                'contentImprovement': 'コンテンツ内容の改善',
                'internalLinks': '内部リンク戦略の改善'
            };
            
            let html = `
                <div class="topic-based-final-section">
                    <h4>${analysisTitle}</h4>
                    <div class="topic-suggestions-grid">
            `;
            
            const topicSuggestions = finalData.finalTopicSuggestions || {};
            
            Object.entries(topicSuggestions).forEach(([topicKey, topicData]) => {
                const topicLabel = topicLabels[topicKey] || topicKey;
                const itemId = `final-topic-${topicKey}`;
                
                html += `
                    <div class="topic-suggestion-card">
                        <div class="topic-suggestion-header" onclick="toggleAIImprovementContent('${itemId}')">
                            <div>
                                <strong>${topicLabel}</strong>
                                ${topicData.implementationPriority ? `<span class="priority-badge ${topicData.implementationPriority}">${topicData.implementationPriority}</span>` : ''}
                            </div>
                            <span class="toggle-icon">▼</span>
                        </div>
                        <div class="topic-suggestion-content" id="${itemId}">
                            ${topicData.finalConclusion ? `
                                <div class="final-conclusion">
                                    <h6>🎯 統合最終結論</h6>
                                    <div>${topicData.finalConclusion}</div>
                                </div>
                            ` : ''}
                            ${topicData.aiComparison ? `
                                <div class="ai-comparison">
                                    <strong>🔍 3AI提案比較</strong><br>
                                    ${topicData.aiComparison}
                                </div>
                            ` : ''}
                            ${topicData.bestChoice ? `
                                <div class="best-choice">
                                    <strong>⭐ 最適選択</strong><br>
                                    ${topicData.bestChoice}
                                </div>
                            ` : ''}
                            ${topicData.expectedImpact ? `
                                <div class="expected-impact">
                                    <strong>💫 期待効果</strong><br>
                                    ${topicData.expectedImpact}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            
            // 全体サマリーがある場合
            if (finalData.overallSummary) {
                html += `
                    <div class="overall-summary-section">
                        <h5>📋 全体サマリー</h5>
                        ${finalData.overallSummary.totalAnalysis ? `
                            <div><strong>総合分析:</strong><br>${finalData.overallSummary.totalAnalysis}</div>
                        ` : ''}
                        ${finalData.overallSummary.implementationOrder && Array.isArray(finalData.overallSummary.implementationOrder) ? `
                            <div class="implementation-order">
                                <strong>実装順序:</strong>
                                <ol>
                                    ${finalData.overallSummary.implementationOrder.map(step => `<li>${step}</li>`).join('')}
                                </ol>
                            </div>
                        ` : ''}
                        ${finalData.overallSummary.totalExpectedImpact ? `
                            <div><strong>総合期待効果:</strong><br>${finalData.overallSummary.totalExpectedImpact}</div>
                        ` : ''}
                    </div>
                `;
            }
            
            html += `</div>`;
            return html;
        }

        // 最終分析カード作成
        function createFinalAnalysisCard(title, finalImprovement) {
            return `
                <div class="final-analysis-card">
                    <h4>${title}</h4>
                    ${finalImprovement.conclusion ? `
                        <div class="final-conclusion">
                            <h5>🎯 最終結論</h5>
                            <div>${finalImprovement.conclusion}</div>
                        </div>
                    ` : ''}
                    ${finalImprovement.analysis ? `
                        <div><strong>📊 統合分析:</strong><br>${finalImprovement.analysis}</div>
                    ` : ''}
                    ${finalImprovement.commonPoints && Array.isArray(finalImprovement.commonPoints) ? `
                        <div><strong>🔗 共通指摘事項:</strong><br>• ${finalImprovement.commonPoints.join('<br>• ')}</div>
                    ` : ''}
                    ${finalImprovement.implementationOrder && Array.isArray(finalImprovement.implementationOrder) ? `
                        <div class="implementation-order">
                            <strong>📋 実装順序:</strong>
                            <ol>
                                ${finalImprovement.implementationOrder.map(step => `<li>${step}</li>`).join('')}
                            </ol>
                        </div>
                    ` : ''}
                    ${finalImprovement.expectedImpact ? `
                        <div><strong>💫 期待効果:</strong><br>${finalImprovement.expectedImpact}</div>
                    ` : ''}
                </div>
            `;
        }

        // AI改善項目のトグル
        function toggleAIImprovementContent(itemId) {
            const content = document.getElementById(itemId);
            const header = content.previousElementSibling;
            const icon = header.querySelector('.toggle-icon');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                icon.classList.remove('collapsed');
            } else {
                content.classList.add('collapsed');
                icon.classList.add('collapsed');
            }
        }

        // SEO改善提案の表示（従来版・互換性維持）
        function displaySEOImprovements(improvements, debug, geminiRaw) {
            const improvementsList = document.getElementById('improvementsList');
            const seoImprovements = document.getElementById('seoImprovements');
            
            let html = '';
            
            // デバッグ情報を表示（開発者向け）
            if (debug) {
                html += `
                    <div class="debug-info" style="background: #f0f0f0; padding: 10px; margin-bottom: 15px; border-radius: 5px; font-size: 12px;">
                        <strong>🔍 分析状況:</strong><br>
                        Gemini API呼び出し: ${debug.geminiCalled ? '✅' : '❌'}<br>
                        改善提案取得: ${debug.geminiHasImprovements ? '✅' : '❌'}<br>
                        提案数: ${debug.improvementsCount}個<br>
                        ${debug.geminiError ? 'エラー: ' + debug.geminiError + '<br>' : ''}
                        ${geminiRaw ? '<details><summary>AI応答の一部 (クリックで展開)</summary><pre style="white-space: pre-wrap; font-size: 11px;">' + geminiRaw + '</pre></details>' : ''}
                    </div>
                `;
            }
            
            if (improvements && improvements.length > 0) {
                improvements.forEach((improvement, index) => {
                    const typeLabel = improvement.type === 'ai-generated' ? '🤖 AI分析' : 
                                     improvement.type === 'debug' ? '🔧 デバッグ' : 
                                     improvement.type === 'fallback' ? '⚠️ フォールバック' : '📋 基本分析';
                    
                    html += `
                        <div class="improvement-item" id="improvement-${index}">
                            <div class="improvement-header" onclick="toggleImprovementContent(${index})">
                                <h4>${typeLabel}: ${improvement.title}</h4>
                                <span class="toggle-icon">▼</span>
                            </div>
                            <div class="improvement-content" id="improvement-content-${index}">
                                <p>${improvement.description}</p>
                                <div class="improvement-actions">
                                    <button class="execute-btn" onclick="executeSpecificImprovement(${index}, '${improvement.type}', '${improvement.title}')">実行</button>
                                    <div class="execution-result-container" style="display: none;"></div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += `
                    <div class="error">
                        改善提案を取得できませんでした。デバッグ情報を確認してください。
                    </div>
                `;
            }
            
            improvementsList.innerHTML = html;
            seoImprovements.style.display = 'block';
        }
        
        // トピッククラスター提案の表示
        function displayTopicClusterSuggestions(suggestions) {
            const clusterSuggestions = document.getElementById('clusterSuggestions');
            const topicCluster = document.getElementById('topicCluster');
            
            let html = `
                <div class="cluster-item">
                    <h4>トピッククラスター構成提案</h4>
                    <p>${suggestions.description}</p>
                    <button class="execute-btn" onclick="executeClusterImprovement()">実行</button>
                </div>
            `;
            
            clusterSuggestions.innerHTML = html;
            topicCluster.style.display = 'block';
        }
        
        // 個別の改善提案実行
        function executeSpecificImprovement(index, type, title) {
            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = '実行中...';
            
            const analysisUrl = document.getElementById('analysisUrl').textContent.replace('分析対象: ', '');
            
            // 結果表示用のコンテナを表示
            const resultContainer = button.parentElement.querySelector('.execution-result-container');
            resultContainer.style.display = 'block';
            resultContainer.innerHTML = '<div class="loading">分析を実行中...</div>';
            
            fetch('execute_improvement.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    url: analysisUrl,
                    index: index,
                    type: type,
                    title: title
                })
            })
            .then(response => response.json())
            .then(data => {
                button.disabled = false;
                button.textContent = originalText;
                
                if (data.success) {
                    displaySpecificExecutionResult(data.result, resultContainer);
                } else {
                    resultContainer.innerHTML = '<div class="error">実行エラー: ' + data.message + '</div>';
                }
            })
            .catch(error => {
                button.disabled = false;
                button.textContent = originalText;
                resultContainer.innerHTML = '<div class="error">実行中にエラーが発生しました: ' + error + '</div>';
            });
        }
        
        // 従来の実行関数（互換性維持のため）
        function executeImprovement(index, type) {
            return executeSpecificImprovement(index, type, '改善提案');
        }
        
        // トピッククラスター改善の実行
        function executeClusterImprovement() {
            const button = event.target;
            button.disabled = true;
            button.textContent = '実行中...';
            
            const analysisUrl = document.getElementById('analysisUrl').textContent.replace('分析対象: ', '');
            
            fetch('execute_cluster.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'url=' + encodeURIComponent(analysisUrl)
            })
            .then(response => response.json())
            .then(data => {
                button.disabled = false;
                button.textContent = '実行';
                
                if (data.success) {
                    displayClusterResult(data.result);
                } else {
                    alert('実行エラー: ' + data.message);
                }
            })
            .catch(error => {
                button.disabled = false;
                button.textContent = '実行';
                alert('実行中にエラーが発生しました: ' + error);
            });
        }
        
        // 個別の改善結果表示
        function displaySpecificExecutionResult(result, container) {
            // MarkdownをHTMLに変換
            const htmlResult = marked.parse(result);
            
            container.innerHTML = `
                <div class="execution-result">
                    <div class="result-header" onclick="toggleResultContent(this)">
                        <h5>改善のポイント:</h5>
                        <span class="toggle-icon">▼</span>
                    </div>
                    <div class="result-content markdown-content">${htmlResult}</div>
                    <button class="copy-result-btn" onclick="copyResultToClipboard(this)">結果をコピー</button>
                </div>
            `;
        }
        
        // 従来の実行結果表示（互換性維持のため）
        function displayExecutionResult(result, parentElement) {
            const resultDiv = document.createElement('div');
            resultDiv.className = 'execution-result';
            resultDiv.innerHTML = `
                <h5>改善結果:</h5>
                <div class="result-content">${result}</div>
            `;
            parentElement.appendChild(resultDiv);
        }
        
        // 結果をクリップボードにコピー
        function copyResultToClipboard(button) {
            const resultContent = button.parentElement.querySelector('.result-content').textContent;
            navigator.clipboard.writeText(resultContent).then(() => {
                const originalText = button.textContent;
                button.textContent = 'コピー済み';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            }).catch(err => {
                console.error('コピーに失敗しました:', err);
            });
        }
        
        // クラスター結果の表示
        function displayClusterResult(result) {
            const clusterSuggestions = document.getElementById('clusterSuggestions');
            
            let html = '';
            
            // ピラーページ情報
            if (result.pillarPage) {
                html += `
                    <div class="pillar-page-section">
                        <h4>🏛️ ピラーページ（中心となる包括的ページ）</h4>
                        <div class="pillar-content">
                            <p><strong>タイトル:</strong> ${result.pillarPage.title}</p>
                            <p><strong>メタディスクリプション:</strong> ${result.pillarPage.metaDescription}</p>
                            <p><strong>メイントピック:</strong> ${result.pillarPage.mainTopic}</p>
                            <p><strong>ターゲットキーワード:</strong> ${result.pillarPage.targetKeywords ? result.pillarPage.targetKeywords.join(', ') : 'N/A'}</p>
                            <p><strong>内容概要:</strong> ${result.pillarPage.description}</p>
                            <button class="create-content-btn" onclick="createPillarContent('${encodeURIComponent(JSON.stringify(result.pillarPage))}')">ピラーページ作成</button>
                        </div>
                    </div>
                `;
            }
            
            // クラスターページ群
            if (result.clusterPages && result.clusterPages.length > 0) {
                html += `
                    <div class="cluster-pages-section">
                        <h4>📄 クラスターページ群（個別詳細記事）</h4>
                        <div class="cluster-pages-list">
                `;
                
                result.clusterPages.forEach((page, index) => {
                    html += `
                        <div class="cluster-page-item">
                            <h5>記事 ${index + 1}: ${page.title}</h5>
                            <p><strong>特定トピック:</strong> ${page.specificTopic}</p>
                            <p><strong>検索意図:</strong> ${page.searchIntent}</p>
                            <p><strong>ターゲットキーワード:</strong> ${page.targetKeywords ? page.targetKeywords.join(', ') : 'N/A'}</p>
                            <p><strong>ピラーページとの関係:</strong> ${page.relationToPillar}</p>
                            <button class="create-content-btn" onclick="createClusterContent('${encodeURIComponent(JSON.stringify(page))}', ${index})">この記事を作成</button>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            // リンク戦略
            if (result.linkingStrategy) {
                html += `
                    <div class="linking-strategy-section">
                        <h4>🔗 内部リンク戦略</h4>
                        <div class="linking-content">
                            <p><strong>ピラー → クラスター:</strong> ${result.linkingStrategy.pillarToCluster}</p>
                            <p><strong>クラスター → ピラー:</strong> ${result.linkingStrategy.clusterToPillar}</p>
                            <p><strong>クラスター間:</strong> ${result.linkingStrategy.clusterToCluster}</p>
                        </div>
                    </div>
                `;
            }
            
            // 測定可能な目標
            if (result.measurableGoals) {
                html += `
                    <div class="goals-section">
                        <h4>🎯 測定可能な目標</h4>
                        <div class="goals-content">
                            <p><strong>重要キーワード:</strong> ${result.measurableGoals.primaryKeywords ? result.measurableGoals.primaryKeywords.join(', ') : 'N/A'}</p>
                            <p><strong>期待流入:</strong> ${result.measurableGoals.expectedTraffic}</p>
                            <p><strong>コンバージョン目標:</strong> ${result.measurableGoals.conversionGoals}</p>
                        </div>
                    </div>
                `;
            }
            
            const resultDiv = document.createElement('div');
            resultDiv.className = 'cluster-result';
            resultDiv.innerHTML = html;
            clusterSuggestions.appendChild(resultDiv);
        }
        
        // ピラーページ作成
        function createPillarContent(encodedResult) {
            const button = event.target;
            button.disabled = true;
            button.textContent = '作成中...';
            
            const result = JSON.parse(decodeURIComponent(encodedResult));
            result.contentType = 'pillar';
            
            createContentRequest(result, button, 'ピラーページ作成');
        }
        
        // クラスターページ作成
        function createClusterContent(encodedResult, index) {
            const button = event.target;
            button.disabled = true;
            button.textContent = '作成中...';
            
            const result = JSON.parse(decodeURIComponent(encodedResult));
            result.contentType = 'cluster';
            result.index = index;
            
            createContentRequest(result, button, 'この記事を作成');
        }
        
        // 従来の本文作成（互換性維持）
        function createContent(encodedResult) {
            const button = event.target;
            button.disabled = true;
            button.textContent = '作成中...';
            
            const result = JSON.parse(decodeURIComponent(encodedResult));
            result.contentType = 'traditional';
            
            createContentRequest(result, button, '本文作成');
        }
        
        // 統一されたコンテンツ作成リクエスト
        function createContentRequest(result, button, originalText) {
            fetch('create_content.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(result)
            })
            .then(response => response.json())
            .then(data => {
                button.disabled = false;
                button.textContent = originalText;
                
                if (data.success) {
                    displayContentResult(data.content, button.parentElement);
                } else {
                    alert('作成エラー: ' + data.message);
                }
            })
            .catch(error => {
                button.disabled = false;
                button.textContent = originalText;
                alert('作成中にエラーが発生しました: ' + error);
            });
        }
        
        // 本文作成結果の表示
        function displayContentResult(content, parentElement) {
            const contentDiv = document.createElement('div');
            contentDiv.className = 'content-result';
            contentDiv.innerHTML = `
                <h5>作成された本文（マークダウン形式）:</h5>
                <textarea class="content-textarea" readonly>${content}</textarea>
                <button class="copy-btn" onclick="copyToClipboard(this.previousElementSibling)">コピー</button>
            `;
            parentElement.appendChild(contentDiv);
        }
        
        // クリップボードにコピー
        function copyToClipboard(textarea) {
            textarea.select();
            document.execCommand('copy');
            
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'コピー済み';
            setTimeout(() => {
                button.textContent = originalText;
            }, 2000);
        }

        // トグル機能
        function toggleImprovementContent(index) {
            const content = document.getElementById(`improvement-content-${index}`);
            const icon = content.parentElement.querySelector('.toggle-icon');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                icon.classList.remove('collapsed');
            } else {
                content.classList.add('collapsed');
                icon.classList.add('collapsed');
            }
        }
        
        function toggleResultContent(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('.toggle-icon');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                icon.classList.remove('collapsed');
            } else {
                content.classList.add('collapsed');
                icon.classList.add('collapsed');
            }
        }

        // 分析済みページ状態をチェックして復元
        function checkExistingAnalyses() {
            // 現在表示されているページについて分析済み状態を確認
            filteredPages.forEach((page, index) => {
                // 実際にはサーバーサイドで確認する必要があるが、
                // 簡単のためクライアントサイドで管理
                // 将来的には get_analyzed_pages.php などで確認
            });
        }

        // ページロード時にサイト一覧を読み込み
        document.addEventListener('DOMContentLoaded', function() {
            loadSites();
        });
    </script>
</body>
</html>